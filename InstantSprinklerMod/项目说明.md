# 洒水器手动触发模组 - 项目说明

## 项目概述

本项目是一个星露谷物语（Stardew Valley）的 SMAPI 模组，实现了手动触发洒水器的功能。玩家可以通过右键点击洒水器来立即浇灌周围的作物，无需等待第二天。

## 项目结构

```
InstantSprinklerMod/
├── InstantSprinklerMod.csproj  # 项目文件
├── Program.cs                   # 主模组类（ModEntry）
├── ModConfig.cs                 # 配置类
├── manifest.json                # SMAPI 模组清单
├── config.json                  # 默认配置文件
├── README.md                    # 英文说明文档
├── 项目说明.md                  # 中文项目说明（本文件）
└── i18n/                        # 国际化翻译文件
    ├── default.json             # 英文翻译
    └── zh.json                  # 中文翻译
```

## 核心功能实现

### 1. 洒水器识别（IsSprinkler）

- 使用 Stardew Valley 1.6 的新 API：`obj.IsSprinkler()`
- 兼容旧版本的 ID 检查：`(BC)599`、`(BC)621`、`(BC)645`

### 2. 范围计算（GetSprinklerCoverage）

支持三种洒水器类型及加压喷头：

| 洒水器 | 基础范围 | 加压喷头后 |
|--------|---------|-----------|
| 普通   | 十字形   | 3x3       |
| 优质   | 3x3     | 5x5       |
| 铱制   | 5x5     | 7x7       |

### 3. 灌溉执行（WaterTile）

- 支持普通土壤（HoeDirt in TerrainFeatures）
- 支持花盆（IndoorPot in Objects）
- 自动检查地块是否在地图范围内

### 4. 视觉反馈

- **动画**：使用 `TemporaryAnimatedSprite` 播放喷水动画
- **音效**：播放 `wateringCan` 音效
- 可通过配置开关

### 5. Generic Mod Config Menu 集成

完整集成了 GMCM API，支持游戏内配置：
- 启用/禁用动画
- 启用/禁用音效
- 体力消耗开关及数值
- 每天一次限制
- 调试模式

## 配置选项详解

### EnableAnimation（启用动画）
- 默认：`true`
- 说明：是否显示喷水动画

### EnableSound（启用音效）
- 默认：`true`
- 说明：是否播放浇水音效

### RequireStamina（需要体力）
- 默认：`false`
- 说明：是否消耗玩家体力
- 建议：如需保持游戏平衡，建议设为 `true`

### StaminaCost（体力消耗）
- 默认：`2.0`
- 范围：`0.0 - 10.0`
- 说明：每次触发消耗的体力值

### OncePerDay（每天一次）
- 默认：`false`
- 说明：限制每个洒水器每天只能手动触发一次
- 建议：如需保持游戏平衡，建议设为 `true`

### DebugMode（调试模式）
- 默认：`false`
- 说明：在 SMAPI 控制台显示调试信息

## 技术实现细节

### 事件驱动架构

```csharp
// 监听按键事件
helper.Events.Input.ButtonPressed += OnButtonPressed;

// 监听每日开始事件（清空已浇水记录）
helper.Events.GameLoop.DayStarted += OnDayStarted;

// 监听游戏启动事件（集成 GMCM）
helper.Events.GameLoop.GameLaunched += OnGameLaunched;
```

### 输入过滤漏斗

1. 检查世界是否就绪：`Context.IsWorldReady`
2. 检查是否有活动菜单：`Game1.activeClickableMenu == null`
3. 检查是否为动作键：`e.Button.IsActionButton()`
4. 检查点击位置是否有洒水器

### 多人游戏兼容性

- 使用 `Helper.Input.Suppress()` 阻止默认行为
- 土壤状态修改会自动同步到其他玩家
- 动画和音效在本地播放

## 构建和部署

### 构建命令

```bash
cd InstantSprinklerMod
dotnet build
```

### 自动部署

`Pathoschild.Stardew.ModBuildConfig` 包会自动：
1. 将模组复制到游戏的 Mods 文件夹
2. 生成发布用的 zip 文件

### 手动安装

1. 将 `bin/Debug/net6.0/InstantSprinklerMod` 文件夹复制到 `Stardew Valley/Mods/`
2. 或使用生成的 zip 文件解压到 Mods 文件夹

## 依赖项

### 必需
- SMAPI 4.0.0+
- Stardew Valley 1.6+
- .NET 6.0

### 可选
- Generic Mod Config Menu（用于游戏内配置）

## 已知限制

1. 不支持 Better Sprinklers 等第三方洒水器范围修改模组
2. 动画效果可能与原版略有差异
3. 多人游戏中，动画仅在触发者本地显示

## 未来改进方向

1. **Better Sprinklers 兼容**：通过反射或 API 获取自定义范围
2. **多人动画同步**：使用 `Multiplayer.broadcastSprites` 广播动画
3. **更多配置选项**：
   - 自定义按键绑定
   - 音效音量调节
   - 动画样式选择
4. **性能优化**：缓存洒水器范围计算结果

## 测试建议

1. 测试所有三种洒水器类型
2. 测试加压喷头附件
3. 测试花盆浇水
4. 测试体力消耗功能
5. 测试每天一次限制
6. 测试多人游戏兼容性
7. 测试 GMCM 配置界面

## 许可证

MIT License

## 作者

Xavier Nico

## 参考文档

- 洒水器手动触发模组文档.txt（技术可行性研究报告）
- [SMAPI 官方文档](https://stardewvalleywiki.com/Modding:Index)
- [Generic Mod Config Menu API](https://github.com/spacechase0/StardewValleyMods/tree/develop/framework/GenericModConfigMenu)

